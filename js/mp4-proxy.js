console.log("turbo player v0.0.25");var __turbo_log={_ls:[],info:function(){__turbo_log._ls.push({err:0,args:arguments}),console.log.apply(null,arguments)},error:function(){__turbo_log._ls.push({err:1,args:arguments}),console.error.apply(null,arguments)}};!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e=524288,t=function(){function t(s,n){this.originRange=n,this.step=e,this.isReady=!1,this.closed=!1,this.requestOffset=0,this.responseOffset=0,this.fileSize=0,this.channelId=s,this.id="".concat(t.idPool++),this.responseOffset=this.requestOffset=n[0],t.instances.set(this.id,this)}return t.get=function(e){return t.instances.get(e)},t.delete=function(e){t.instances.delete(e)},t.prototype.updateStep=function(t,s){var n=t/s;n&&(this.step=Math.max(Math.ceil(3*n),e))},t.prototype.start=function(){var e;null===(e=this.client)||void 0===e||e.postMessage({type:"GET_HEAD",channelId:this.channelId,streamId:this.id,message:{range:this.originRange}})},t.prototype.pull=function(e){var t;if(!(this.requestOffset>this.range[1]||this.responseOffset!==this.requestOffset||this.closed)){var s=this.requestOffset,n=s+(0===s?16384:this.step)-1;n>=this.range[1]&&(n=this.range[1]);var i=[s,n];null===(t=this.client)||void 0===t||t.postMessage({type:"GET_DATA",channelId:this.channelId,streamId:this.id,message:{range:i}}),this.requestOffset=n+1}},t.prototype.ready=function(e,s){var n=this,i=e[0],r=e[1];if(!this.isReady){this.range=[i,r],this.fileSize=s,this.isReady=!0;var a=r-i+1;this.stream=new ReadableStream({start:function(e){n.controller=e},pull:function(e){n.pull(e)},cancel:function(e){n.closed=!0,t.delete(n.id)}}),this.resolve(new Response(this.stream,{status:206,statusText:"Partial Content",headers:[["Connection","keep-alive"],["Content-Type","video/mp4"],["Cache-Control","max-age=0"],["Content-Length","".concat(a)],["Content-Range","bytes ".concat(i,"-").concat(r,"/").concat(s)]]}))}},t.prototype.response=function(){var e=this;return new Promise((function(t){e.resolve=t}))},t.prototype.enqueue=function(e){this.closed||(this.responseOffset+=e.byteLength,this.controller.enqueue(e),this.responseOffset===this.range[1]+1&&this.close())},t.prototype.close=function(){this.controller.close(),this.closed=!0,t.delete(this.id)},t.idPool=1,t.instances=new Map,t}();self.addEventListener("install",(function(){self.skipWaiting()})),self.addEventListener("activate",(function(e){e.waitUntil(self.clients.claim())})),self.addEventListener("message",(function(e){if(e.data){var s=e.data;if(s.streamId){var n=t.get(s.streamId);if(n)if("DATA"===s.type){var i=s.message.buffer;if(n.isReady)try{n.enqueue(i)}catch(e){}}else if("HEAD"===s.type){var r=s.message,a=r.range,o=r.size,l=r.duration;n.ready(a,o),n.updateStep(o,l)}else if("BYTE_RATE"===s.type){var c=s.message;o=c.size,l=c.duration;n.updateStep(o,l)}}}})),self.addEventListener("fetch",(function(e){var s,n=new URL(e.request.url),i=function(e){var t=new URL(e),s=new URLSearchParams(t.search),n=s.get("id"),i=s.get("url");if(i&&n)return{id:n,realUrl:decodeURIComponent(i)}}(n.href);if(i){var r=i.id,a=i.realUrl;if(n.pathname.includes("meta-edge-sw-proxy/media")&&a){var o=null===(s=e.request.headers.get("Range"))||void 0===s?void 0:s.split("=")[1].split("-").map((function(e){return e?parseInt(e,10):void 0}));if(!o)return;var l=new t(r,o);self.clients.get(e.clientId).then((function(e){l.client=e,l.start()})),e.respondWith(l.response())}}}))}));
//# sourceMappingURL=mp4-proxy.js.map
